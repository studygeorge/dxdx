# ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç www -> non-www
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name www.dxcapital-ai.com;
    
    ssl_certificate /etc/letsencrypt/live/dxcapital-ai.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dxcapital-ai.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    return 301 https://dxcapital-ai.com$request_uri;
}

# ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –û–ë–õ–ï–ì–ß–Å–ù–ù–´–ô –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    
    server_name dxcapital-ai.com;
    
    ssl_certificate /etc/letsencrypt/live/dxcapital-ai.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dxcapital-ai.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    access_log /var/log/nginx/dxcapital-access.log;
    error_log /var/log/nginx/dxcapital-error.log;
    
    # üöÄ –ë–ï–ó –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ô - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –°–ö–û–†–û–°–¢–¨
    client_max_body_size 0;  # –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
    client_body_buffer_size 128k;
    client_body_timeout 0;  # –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
    client_header_timeout 0;  # –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
    
    proxy_connect_timeout 0;  # –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
    proxy_send_timeout 0;  # –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
    proxy_read_timeout 0;  # –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
    send_timeout 0;  # –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ
    
    # üöÄ –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ï –ë–£–§–ï–†–´
    proxy_buffer_size 256k;
    proxy_buffers 8 256k;
    proxy_busy_buffers_size 512k;
    
    # üöÄ –û–¢–ö–õ–Æ–ß–ê–ï–ú –ë–£–§–ï–†–ò–ó–ê–¶–ò–Æ –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–•
    proxy_buffering off;
    proxy_request_buffering off;

    # ‚úÖ API Backend (–ø–æ—Ä—Ç 4000)
    location /api/ {
        proxy_pass http://localhost:4000/api/;
        proxy_http_version 1.1;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache_bypass $http_upgrade;
        
        # –ë–ï–ó –¢–ê–ô–ú–ê–£–¢–û–í
        proxy_connect_timeout 0;
        proxy_send_timeout 0;
        proxy_read_timeout 0;
        
        # –ù–ï –ö–≠–®–ò–†–£–ï–ú
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
    }
    
    # ‚úÖ Backend Uploads
    location /uploads/ {
        proxy_pass http://localhost:4000/uploads/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        
        # –ë–ï–ó –¢–ê–ô–ú–ê–£–¢–û–í
        proxy_connect_timeout 0;
        proxy_send_timeout 0;
        proxy_read_timeout 0;
    }

    # ‚úÖ Next.js Frontend (–ø–æ—Ä—Ç 3000) - –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–û –ë–´–°–¢–†–û
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
        proxy_set_header Referer $http_referer;
        
        proxy_cache_bypass $http_upgrade;
        
        # –ë–ï–ó –¢–ê–ô–ú–ê–£–¢–û–í
        proxy_connect_timeout 0;
        proxy_send_timeout 0;
        proxy_read_timeout 0;
        
        # –ù–ï –ö–≠–®–ò–†–£–ï–ú
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        
        # üöÄ –û–¢–ö–õ–Æ–ß–ê–ï–ú –ë–£–§–ï–†–ò–ó–ê–¶–ò–Æ
        proxy_buffering off;
        proxy_request_buffering off;
    }
}

# ‚úÖ HTTP to HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç
server {
    listen 80;
    listen [::]:80;
    
    server_name dxcapital-ai.com www.dxcapital-ai.com;
    
    return 301 https://dxcapital-ai.com$request_uri;
}
